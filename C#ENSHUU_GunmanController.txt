using UnityEngine;
//ファイル名をGunmanController.csに変えてからUnityEditorで使用すること
/// <summary>
/// ガンマンのキャラクターを操作するコンポーネント
/// </summary>
public class GunmanController : MonoBehaviour
{
    /// <summary>左右移動する力</summary>
    [SerializeField] float m_movePower = 5f;
    /// <summary>ジャンプする力</summary>
    [SerializeField] float m_jumpPower = 15f;
    /// <summary>色の配列</summary>
    [SerializeField] Color[] m_colors = default;
    /// <summary>弾丸のプレハブ</summary>
    [SerializeField] GameObject m_bulletPrefab = default;
    /// <summary>銃口の位置を設定するオブジェクト</summary>
    [SerializeField] Transform m_muzzle = default;
    /// <summary>入力に応じて左右を反転させるかどうかのフラグ</summary>
    [SerializeField] bool m_flipX = false;
    Rigidbody2D m_rb = default;
    SpriteRenderer m_sprite = default;
    /// <summary>m_colors に使う添字</summary>
    int m_colorIndex = 0;//初期値の設定　配列の添え字は0スタートで添え字が0の色から循環させたいので0を代入し、0以外の数値が格納されてしまっている事故を防ぐため。
    /// <summary>水平方向の入力値</summary>
    float m_h;
    float m_scaleX;
    /// <summary>最初に出現した座標</summary>
    Vector3 m_initialPosition;

    /// <summary>
    /// ジャンプ数のカウントとフラグ
    /// </summary>
    [SerializeField] int jumpCount = 2;
    [SerializeField] bool isGrounded = false;

    /// <summary>
    /// プレイヤーの向いている向きのフラグ
    /// </summary>
    [SerializeField] bool LookingRight = true;

    void Start()
    {
        m_rb = GetComponent<Rigidbody2D>();
        m_sprite = GetComponent<SpriteRenderer>();
        // 初期位置情報を変数に保管
        m_initialPosition = this.transform.position;
    }

    void Update()
    {
        // 入力を受け取る
        m_h = Input.GetAxisRaw("Horizontal");

        // 各種入力を受け取る
        if (Input.GetButtonDown("Jump"))
        {
            if (jumpCount > 0)//ジャンプができる残りの回数がある場合に呼び出される条件文
            {
                m_rb.AddForce(new Vector2(0,m_jumpPower),ForceMode2D.Impulse);//キャラの打ち上げ、瞬間的に力を加えるので　
                                                                              //ForceMode2DのImpulseを呼び出して力の加え方を指定する
                jumpCount--;//残りの可能なジャンプの回数をジャンプをするたびに減らす。
                            //ここではデクリメント（jumpcount -= 1または jumpcount += -1）をしている。
            }
        }

        if (Input.GetButtonDown("Fire1"))
        {
            GameObject bullet = Instantiate(m_bulletPrefab);//弾丸の発射が呼び出されている場合には弾丸のオブジェクト（プレハブ）を生成
            bullet.transform.position = m_muzzle.position;//生成に伴って、どこの位置に生成をするか任意のTransformのPosisionを代入している。
            bullet.GetComponent<BulletController>().lookingRight = LookingRight;//キャラ（Gunman）が右を向いているかどうかのステータス判定
                                                                                //（ここではBool型の変数）に値（bool：trueかfalse、int：1か0）の代入。加えてこのフラグの情報を弾丸のプレハブに渡したいので
                                                                                //弾丸のプレハブのコンポーネントの右方向判定用のフラグを探してそれにフラグの値を代入している
        }

        if (Input.GetButtonDown("Fire2"))
        {
            if (m_colorIndex < m_colors.Length)//キャラの画像の色を変えるための色が配列m_colorsに格納されている。
                                               //ここでは色が要素数0から順番に最後の色の格納されている要素数の色まで変わるようにしたい。
                                               //まず、0から配列の最後尾までのデータを呼び出したいのでfor文かif文を使用して処理をしたほうが効果的で適切と仮定して、
                                               //あくまでも特定の条件下で処理をしたいので特定の条件下でのみ呼び出しをしないif文を使ってみる。処理をさせたい条件下は下記の通り、
                                               //三色配列内に格納されていると仮定して、赤ー＞青ー＞黄の順番で色が変化し、黄色の次は赤になるようにする。
                                               //つまり配列内の色（要素）で循環するようにしたい。
                                               //そのためにはまず現状の配列の添え字（index）：選択された要素が配列の長さにおさまらないといけないので、
                                               //配列の現状の添え字：m_colorIndex が　配列の長さ：m_colors.Length　に値がおさまっているときのみ処理をする。
            {
                m_sprite.color = m_colors[m_colorIndex];//現状の添え字の要素に書くのされている色をキャラの色に設定（代入）
                if (m_colorIndex % m_colors.Length < m_colors.Length - 1 && m_colorIndex / m_colors.Length != 1)//仮に配列の長さが3、現状の添え字が3未満の場合、現状の添え字を配列の長さで割った「余剰は必ず配列の長さ（値：2）より値が大きくなることはない。」
                                                                                                                //同時に商は1にはならない。これを条件として処理をしていく。これをＦｉｒｅ２が呼び出されるたび循環させるの
                {
                    m_colorIndex++;//インクリメント
                }
                else
                {
                    m_colorIndex = 0;//商が1になった場合には添え字の初期化をする。
                }
            }
        }

        // 下に行きすぎたら初期位置に戻す
        if (this.transform.position.y < -10f)
        {
            this.transform.position = m_initialPosition;
        }

        // 設定に応じて左右を反転させる
        if (m_flipX)
        {
            FlipX(m_h);
        }
    }

    private void FixedUpdate()
    {
        // 力を加えるのは FixedUpdate で行う
        m_rb.AddForce(Vector2.right * m_h * m_movePower, ForceMode2D.Force);
    }

    /// <summary>
    /// 左右を反転させる
    /// </summary>
    /// <param name="horizontal">水平方向の入力値</param>
    void FlipX(float horizontal)
    {
        /*
         * 左を入力されたらキャラクターを左に向ける。
         * 左右を反転させるには、Transform:Scale:X に -1 を掛ける。
         * Sprite Renderer の Flip:X を操作しても反転する。
         * */
        m_scaleX = this.transform.localScale.x;

        if (horizontal > 0)
        {
            this.transform.localScale = new Vector3(Mathf.Abs(this.transform.localScale.x), this.transform.localScale.y, this.transform.localScale.z);
            LookingRight = true;//入力値からして右を向いているため右を向いているときのフラグを立てる。
        }
        else if (horizontal < 0)
        {
            this.transform.localScale = new Vector3(-1 * Mathf.Abs(this.transform.localScale.x), this.transform.localScale.y, this.transform.localScale.z);
            LookingRight = !true;//入力値からして左を向いているため右を向いているときのフラグを下げる：trueの!（否定、ＮＯＴ、値の反転をしている）
        }
    }

    private void OnTriggerExit2D(Collider2D collision)
    {
        if (collision.CompareTag("Ground"))
        {
            isGrounded = !true;//接地フラグの設定
        }
    }

    private void OnTriggerEnter2D(Collider2D collision)
    {
        if (collision.CompareTag("Ground"))
        {
            isGrounded = true;//接地フラグの設定
            jumpCount = 2;//地面に足がついている時にできるジャンプ数を初期値に戻す（ここでは初期値 = 2）
        }
    }
}
